name: TEST 7.0

on:
  workflow_dispatch:
    inputs:
      LinuxFamily:
        description: 'Linux Family'
        required: true
        default: 'meson64'
        type: choice
        options:
          - 'rockchip64'
          - 'meson64'
      BRANCH:
        description: 'Linux Branch'
        default: 'edge'
        required: true
        type: choice
        options:
          - 'edge'
      RC_VERSION:
        description: 'Build RC Version'
        default: '1'
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
          - '7'
          - '8'
      EXTRAWIFI:
        description: 'Several Wifi Drivers'
        default: 'yes'
        required: false
        type: choice
        options:
          - 'yes'
          - 'no'
      CPUTHREADS:
        description: 'CPU Therads'
        default: '4'
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      # PR:
        # description: 'Enter the PR number to build'
        # required: true
        # type: string

env:
  TZ: Asia/Shanghai
  BRANCH: ${{ inputs.BRANCH }}

jobs:
  Build-Kernel:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> ${GITHUB_ENV}
          docker_images_ids=$(docker images -q)
          [ -n "${docker_images_ids}" ] && docker rmi ${docker_images_ids}
          docker system prune -a -f
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* openjdk* mysql* php* mongodb* moby* snapd* android* || true
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo -E apt-get clean
          sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          sudo rm -rf ~/{.cargo,.dotnet,.rustup}
          sudo timedatectl set-timezone "${TZ}"

      - name: Create simulated physical disk
        id: disk
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          LOOP_MNT=$(sudo losetup -f --show /mnt/mnt.img)
          LOOP_ROOT=$(sudo losetup -f --show /root.img)
          sudo pvcreate "${LOOP_MNT}"
          sudo pvcreate "${LOOP_ROOT}"
          sudo vgcreate -y github "${LOOP_MNT}" "${LOOP_ROOT}"
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs /dev/github/runner
          sudo mkdir -p /mnt/workdir
          sudo mount /dev/github/runner /mnt/workdir
          sudo chown -R ${USER}:${USER} /mnt/workdir
          df -Th

      - name: Download source code
        working-directory: /mnt/workdir
        run: |
          df -hT ${PWD}
          git clone -q --branch=main https://github.com/armbian/build build
          ln -sf /mnt/workdir/build ${GITHUB_WORKSPACE}/build
          # cd ${GITHUB_WORKSPACE}/build
          # git config --global user.name "GitHub Actions"
          # git config --global user.email "actions@github.com"
          # git fetch origin pull/${{ inputs.PR }}/head:pr-branch
          # git merge pr-branch --no-ff --strategy=recursive -X theirs -m "Merge PR #${{ inputs.PR }} into main"

      - name: Apply patches
        working-directory: /mnt/workdir/build
        run: |
          "${GITHUB_WORKSPACE}/scripts/apply_patches.sh"
          "${GITHUB_WORKSPACE}/scripts/rename_to_conf.sh"
          sed -i 's|https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git|https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git|g' lib/functions/configuration/main-config.sh
          sed -i "s|7\.0-rc[1-8]|7\.0-rc${{ inputs.RC_VERSION }}|g" config/sources/mainline-kernel.conf.sh
          cp -rf patch/kernel/archive/meson64-6.19 patch/kernel/archive/meson64-7.0
          sed -i "s|6\.19|7\.0|g" config/sources/families/include/meson64_common.inc
          cp -f ${GITHUB_WORKSPACE}/patch/N1/7.0/* patch/kernel/archive/meson64-7.0/ || true
          rm -f patch/kernel/archive/meson64-7.0/board-odroid-sm1-regulators-boot-on.patch
          rm -f patch/kernel/archive/meson64-7.0/board-radxa-zero2-dts-amlogic-describe-the-FUSB302-on-Radxa-Zero-2.patch
          rm -f patch/kernel/archive/meson64-7.0/general-gpu-drm-add-new-display-resolution-2560x1440.patch

          # cp -f ${GITHUB_WORKSPACE}/patch/N1/fix-n1-1.patch patch/kernel/archive/meson64-7.0/ || true
          # cp -f ${GITHUB_WORKSPACE}/patch/N1/fix-n1-2.patch patch/kernel/archive/meson64-7.0/ || true
          # rm -f patch/kernel/archive/meson64-7.0/general-soc-0001-soc-amlogic-meson-gx-socinfo-move-common-code-to-hea.patch
          # rm -f patch/kernel/archive/meson64-7.0/general-soc-0002-soc-amlogic-meson-gx-socinfo-sm-Add-Amlogic-secure-m.patch
          # cp -f ${GITHUB_WORKSPACE}/patch/T4/fix-CPU-information-6.16.patch patch/kernel/archive/rockchip64-6.19/ || true
          # cp -f ${GITHUB_WORKSPACE}/patch/T4/t4.patch patch/kernel/archive/rockchip64-6.19/ || true
          # cp -f ${GITHUB_WORKSPACE}/patch/X2/rk3566-panther-x2.dts patch/kernel/archive/rockchip64-6.19/dt/ || true
          # cp -f ${GITHUB_WORKSPACE}/patch/JP/rk3566-jp-tvbox.dts patch/kernel/archive/rockchip64-6.19/dt/ || true

      - name: Compile Kernel [ ${{ inputs.LinuxFamily }} ${{ inputs.BRANCH }} ]
        working-directory: /mnt/workdir/build
        run: |
          BoardFamily=${{ inputs.LinuxFamily }}
          case "${BoardFamily}" in
            rockchip64) BoardFamily="nanopct4" ;;
            meson64)    BoardFamily="aml-s9xx-box" ;;
          esac
          ./compile.sh kernel BOARD=${BoardFamily} BRANCH=${{ inputs.BRANCH }} EXTRAWIFI=${{ inputs.EXTRAWIFI }} CPUTHREADS=${{ inputs.CPUTHREADS }} PREFER_DOCKER=no DOCKER_ARMBIAN_BASE_IMAGE=ubuntu:noble DEB_COMPRESS=xz SHARE_LOG=yes

      - name: Prepare Kernel Metadata
        working-directory: /mnt/workdir/build/output/debs
        run: |
          Kernel_File=$(find . -maxdepth 1 -type f -name 'linux-image-*.deb' -printf '%f\n' | head -n 1)
          if [ -n "${Kernel_File}" ]; then
            echo "Kernel_File: ${Kernel_File}"
            KERNEL_VERSION=$(echo "${Kernel_File}" | cut -d '_' -f 5 | cut -d '-' -f 1)
            [[ ! "${KERNEL_VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && KERNEL_VERSION="${KERNEL_VERSION}.0"
            echo "KERNEL_VERSION=${KERNEL_VERSION}" >> ${GITHUB_ENV}
            echo "KERNEL_VERSION: ${KERNEL_VERSION}"
            LINUX_FAMILY=$(echo "${Kernel_File}" | cut -d '_' -f 1 | awk -F '-' '{print $NF}')
            echo "LINUX_FAMILY=${LINUX_FAMILY}" >> ${GITHUB_ENV}
            echo "LINUX_FAMILY: ${LINUX_FAMILY}"
          else
            echo "No matching file found. Available files are:"
            ls -1 "/mnt/workdir/build/output/debs"
            exit 1
          fi
          matching_files_array=($(ls linux-dtb* linux-headers* linux-image* linux-libc* 2>/dev/null))
          if [ ${#matching_files_array[@]} -gt 0 ]; then
            renamed_files=()
            for f in "${matching_files_array[@]}"; do
              base_name=$(echo "${f}" | sed -E 's/_.*//')
              newf="${base_name}-${KERNEL_VERSION}.deb"
              if [ "${f}" != "${newf}" ]; then
                echo "Renaming: ${f} â†’ ${newf}"
                mv "${f}" "${newf}"
              fi
              renamed_files+=("${newf}")
            done
            tar -czf "../kernel-${KERNEL_VERSION}-${LINUX_FAMILY}.tar.gz" "${renamed_files[@]}" || { echo "Failed to create tar.gz file"; exit 1; }
            echo "Compressed matching files to kernel-${KERNEL_VERSION}-${LINUX_FAMILY}.tar.gz"
          else
            echo "No matching files found for compression."
            ls -1 "/mnt/workdir/build/output/debs"
            exit 1
          fi
          tar -tzf "../kernel-${KERNEL_VERSION}-${LINUX_FAMILY}.tar.gz" > /dev/null || { echo "Failed to verify tar.gz file"; exit 1; }

      - name: Upload Kernel to Release
        uses: ncipollo/release-action@main
        with:
          tag: "Kernel-${{ env.LINUX_FAMILY }}"
          name: "Kernel-${{ env.LINUX_FAMILY }}"
          artifacts: "/mnt/workdir/build/output/kernel-${{ env.KERNEL_VERSION }}-${{ env.LINUX_FAMILY }}.tar.gz"
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### Armbian Kernel Packages for ${{ env.LINUX_FAMILY }}
            - Usage: After extraction, install the packages (e.g. `dpkg -i *.deb`)
            - Included: `linux-dtb` `linux-headers` `linux-image` `linux-libc-dev`
          draft: false
          prerelease: false

      - name: Prepare SHA256 Metadata
        working-directory: /mnt/workdir/build/output
        run: |
          sleep 15 && "${GITHUB_WORKSPACE}/scripts/sha256.sh"

      - name: Upload SHA256 to Release
        uses: ncipollo/release-action@main
        with:
          tag: "Kernel-${{ env.LINUX_FAMILY }}"
          name: "Kernel-${{ env.LINUX_FAMILY }}"
          artifacts: "/mnt/workdir/build/output/sha256.txt"
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### Armbian Kernel Packages for ${{ env.LINUX_FAMILY }}
            - Usage: After extraction, install the packages (e.g. `dpkg -i *.deb`)
            - Included: `linux-dtb` `linux-headers` `linux-image` `linux-libc-dev`
          draft: false
          prerelease: false

      - name: Delete releases and workflows runs
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: false
          releases_keep_latest: 10
          delete_workflows: true
          workflows_keep_day: 3
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate Workflow Duration
        id: duration
        run: |
          start_time="${{ env.START_TIME }}"
          echo "Start time: ${start_time}"
          end_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "End time: ${end_time}"
          duration=$(( $(date -d "${end_time}" +%s) - $(date -d "${start_time}" +%s) ))
          echo "Workflow duration: ${duration} seconds"
          echo "DURATION=${duration}" >> ${GITHUB_ENV}

      - name: Telegram notification
        run: |
          HOURS=$(( ${{ env.DURATION }} / 3600 ))
          MINUTES=$(( ( ${{ env.DURATION }} % 3600 ) / 60 ))
          SECONDS=$(( ${{ env.DURATION }} % 60 ))
          if [ ${HOURS} -eq 0 ]; then
            MSG="
          ðŸŽ‰ *${{ env.KERNEL_VERSION }}-${{ env.LINUX_FAMILY }} ç¼–è¯‘å®Œæˆï¼*
          ðŸ•’ _${MINUTES} åˆ† ${SECONDS} ç§’_"
          else
            MSG="
          ðŸŽ‰ *${{ env.KERNEL_VERSION }}-${{ env.LINUX_FAMILY }} ç¼–è¯‘å®Œæˆï¼*
          ðŸ•’ _${HOURS} æ—¶ ${MINUTES} åˆ† ${SECONDS} ç§’_"
          fi
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_ID }}" ]; then
            echo "Telegram secrets are incomplete, skipping notification."
            exit 0
          else
            echo "Sending message: ${MSG}"
            curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_ID }}&text=${MSG}&parse_mode=Markdown" >/dev/null 2>&1
          fi
